<!DOCTYPE html>
<html>
<head>
    <script src="./phaser.js" type="text/javascript"></script>
</head>
<body>
    <script type="text/javascript">
        var Player = function(opts) {
            this.x = opts.x || 0;
            this.y = opts.y || 0;
            this.z = opts.z || 0;
        };

        var Road = function(opts) {
            // 道路宽度（3d world）
            this.width = 2000;
            // 道路分段
            this.segments = [];
            // 道路分段数量
            this.segmentCount = 500;
            // 道路分段间距
            this.segmentGap = 200;
            // 车道数量
            this.lanes = 3;
            // 道路颜色
            this.colors = {
                light : {road : '#6B6B6B', grass : '#10AA10', rumble : '#555555', lane : '#CCCCCC'},
                dark : {road : '#696969', grass : '#009A00', rumble : '#BBBBBB'}
            };

            // Phaser实例
            this.engine = opts.engine;
            // 道路canvas，最后被画入主canvas
            this.bitmap = this.engine.add.bitmapData(this.engine.width, this.engine.height);

            // 初始化道路分段
            for(var i = 0; i < this.segmentCount; i++) {
                this.segments.push({
                    z : this.segmentGap * i,
                    color : i % 2 ? this.colors.light : this.colors.dark
                });
            }

            // 将道路canvas加入主canvas
            this.engine.add.image(0, 0, this.bitmap);
        };

        Road.prototype = {

            project : function(x, y, z) {
                var d = this.distCameraToScreen;
                // d / (z - this.cameraZ) = screenY / (y - this.cameraY);
                // d / (z - this.cameraZ) = screenX / (x - this.cameraX);
                return {
                    screenX : Math.round(d / z * (x - this.cameraX)),
                    screenY : Math.round(d / z * (y - this.cameraY))
                }
            },

            polygon : function() {}
        }

        function Racer(opts) {
            //水平视角
            this.fieldOfView = 100 / 180 * Math.PI;
            //屏幕与眼球间的距离
            this.distCameraToScreen = this.resolutionX / 2 / Math.tan(this.fieldOfView / 2);
            this.engine = new Phaser.Game(this.resolutionX, this.resolutionY, Phaser.AUTO, "racer");
            this.engine.state.add("racer", this, true);
        }

        Racer.prototype = {
            resolutionX : 640,

            resolutionY : 480,

            cameraX : 0,

            cameraY : 2000,

            cameraZ : 0,

            preload : function() {
                this.engine.load.image("background-hills", "javascript-racer-master/images/background/hills.png");
                this.engine.load.image("background-sky", "javascript-racer-master/images/background/sky.png");
                this.engine.load.image("background-trees", "javascript-racer-master/images/background/trees.png");
                this.engine.load.image("player-left", "javascript-racer-master/images/sprites/player_left.png");
                this.engine.load.image("player-right", "javascript-racer-master/images/sprites/player_right.png");
                this.engine.load.image("player-straight", "javascript-racer-master/images/sprites/player_straight.png");
            },

            create : function() {
                this.engine.add.sprite(0, 0, "background-sky");
                this.engine.add.sprite(0, 0, "background-hills");
                this.engine.add.sprite(0, 0, "background-trees");

                this.road = new Road({engine : this.engine});
                // this.player = new Player({engine : this.engine});             
            },

            update : function() {
                // this.road.update();
            }

            // update : function() {
            //     var that = this;
            //     this.road.segments.forEach(function(segment) {
            //         var p1 = that.project(-that.road.width / 2, 0, segment.z),
            //             p2 = that.project(-that.road.width / 2, 0, segment.z + that.road.segmentGap),
            //             p3 = that.project(that.road.width / 2, 0, segment.z),
            //             p4 = that.project(that.road.width / 2, 0, segment.z + that.road.segmentGap);
            //         that.polygon(
            //             that.engine.canvas.getContext("2d"),
            //             p1.screenX,
            //             p1.screenY,
            //             p2.screenX,
            //             p2.screenY,
            //             p3.screenX,
            //             p3.screenY,
            //             p4.screenX,
            //             p4.screenY,
            //             segment.color.road
            //         );
            //     });
            // }
        };

        var racer = new Racer();
    </script>
</body>
</html>